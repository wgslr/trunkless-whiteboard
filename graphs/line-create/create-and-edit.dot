# deeppink = message from server
# blue = message to server

Digraph G {
  labelloc="t";
  label="Line create and update";

  subgraph cluster_u1 {
    label="client u1"
    
    empty
    -> "LOCAL_ONLY:rev1:line_id"
    [label = "user draws line up to rev1"]
    
    "LOCAL_ONLY:rev1:line_id"
    -> "WAITING_FOR_ACK:rev1:line_id"
    [label = "<u1: line_create(line_id, rev1)" color=blue]

    "WAITING_FOR_ACK:rev1:line_id"
    -> "WAITING_FOR_ACK:rev1:line_id 
        LOCAL_ONLY:rev2:line_id"
    [label="user continues the same line"]

    "WAITING_FOR_ACK:rev1:line_id 
        LOCAL_ONLY:rev2:line_id"
    -> "ACKED_BY_SERVER:rev1:line_id 
        LOCAL_ONLY:rev2:line_id"
          [label=">u1: line_create_success(line_id)" color=deeppink]


    "ACKED_BY_SERVER:rev1:line_id 
        LOCAL_ONLY:rev2:line_id"
    -> "ACKED_BY_SERVER:rev1:line_id
        WAITING_FOR_ACK:rev2:line_id"
    [label="<u1: line_update(line_id, rev2)" color=blue]

    "ACKED_BY_SERVER:rev1:line_id
        WAITING_FOR_ACK:rev2:line_id"
    -> "ACKED_BY_SERVER:rev2:line_id"
    [label=">u1: line_update_success(line_id, rev2)" color=deeppink]  // here either rev2 bitmap or some revision / message id


    // error cases
    "WAITING_FOR_ACK:rev1:line_id" -> empty [label = "<u1: line_create_error(line_id)", color=deeppink]

    "WAITING_FOR_ACK:rev1:line_id 
        LOCAL_ONLY:rev2:line_id" -> empty [label = "<u1: line_create_error(line_id)", color=deeppink]

    "ACKED_BY_SERVER:rev1:line_id
        WAITING_FOR_ACK:rev2:line_id"
    -> "ACKED_BY_SERVER:rev1:line_id"
    [label="<u1: line_update_error(line_id, rev2)" color=deeppink]

  }

  subgraph cluster_u2 {
    label = "client u2"

    "EMPTY" -> "KNOWN_FROM_SERVER:rev1"
    [label = ">all: line_created(line_id, rev1bitmap)" color=deeppink]

    "KNOWN_FROM_SERVER:rev1" -> "KNOWN_FROM_SERVER:rev2"
    [label = ">all: line_updated(line_id, rev2bitmap)" color=deeppink]

  }
}


